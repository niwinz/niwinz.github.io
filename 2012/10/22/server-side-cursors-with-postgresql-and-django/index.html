<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>niwi.nz : Server side cursors with PostgreSQL and Django.</title>
    <meta name=viewport content='width=200, initial-scale=1'>

  <meta name="desciption" content="By default on using postgresql_psycopg2 backend, when a database query is executed, the psycopg2.cursor usually fetches all the records returned by the backend, transferring them to the client process. If the query returned an huge amount of data, a proportionally large amount of memory will be allocated by the client. If the dataset is too large to be practically handled on the client side, it is possible to create a server side cursor. Using this kind of cursor it is possible to transfer..." />
    <meta name="author" content="Andrey Antukh" />

    <link rel="stylesheet" href="https://niwi.nz/theme/css/main.css" />

      <link href="https://niwi.nz/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="niwi.nz Atom Feed" />

      <link href="https://niwi.nz/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="niwi.nz RSS Feed" />

    <!--[if IE]>
        <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!--[if lte IE 7]>
        <link rel="stylesheet" type="text/css" media="all" href="https://niwi.nz/css/ie.css"/>
        <script src="https://niwi.nz/js/IE8.js" type="text/javascript"></script>
    <![endif]-->

    <!--[if lt IE 7]>
        <link rel="stylesheet" type="text/css" media="all" href="https://niwi.nz/css/ie6.css"/>
    <![endif]-->
  </head>

  <body>
    <div id="wrap">
      <div id="container">

        <div class="entry">
  <header>
    <a href="https://niwi.nz"><small>(return to home)</small></a>
    <h1>
      <a href="https://niwi.nz/2012/10/22/server-side-cursors-with-postgresql-and-django/" id="page-title">Server side cursors with PostgreSQL and Django.</a>
    </h1>
    <div class="article-meta">
        <small class="time">
          Date:
          <time datetime="2012-10-22T00:00:00+00:00">
            Mon 22 October 2012
          </time>
        </small>
      <br />
      <small class="tags">
        Tags:
          <a href="https://niwi.nz/tag/postgresql.html">postgresql,           </a>
          <a href="https://niwi.nz/tag/django.html">django          </a>
      </small>

      <br />
      <small class="tags">
        Author:
          <span>Andrey Antukh</span>      </small>
    </div>
  </header>
  <article>
    <div id="article-content">
      <p>By default on using <code>postgresql_psycopg2</code> backend, when a database query is executed, the <code>psycopg2.cursor</code> usually fetches all the records returned by the backend, transferring them to the client process. If the query returned an huge amount of data, a proportionally large amount of memory will be allocated by the client.</p>
<p>If the dataset is too large to be practically handled on the client side, it is possible to create a server side cursor. Using this kind of cursor it is possible to transfer to the client only a controlled amount of data, so that a large dataset can be examined without keeping it entirely in memory.</p>
<p>Server side cursor are created in PostgreSQL using the DECLARE command and subsequently handled using MOVE, FETCH and CLOSE commands.</p>
<p><a href="https://github.com/niwibe/djorm-ext-core">djorm-ext-core</a> module contains a simple integration (as python context manager) of server side cursors with django.</p>
<p>Here is an example of use:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">transaction</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">View</span>
<span class="kn">from</span> <span class="nn">djorm_core.postgresql</span> <span class="kn">import</span> <span class="n">server_side_cursors</span>

<span class="k">class</span> <span class="nc">SomeView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="nd">@transaction</span><span class="o">.</span><span class="n">commit_on_success</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">server_side_cursors</span><span class="p">(</span><span class="n">itersize</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">Model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">process_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># [...]</span>
</code></pre></div>

<p>All queries executed within a context manager creates new database level cursor insteand of fetching all amount of data to client side.</p>
<p>In order to work, you have to add <code>djorm_core.postgresql</code> to <code>INSTALLED_APPS</code> in your settings.py</p>
<p>You can install it with <code>pip install djorm-ext-core</code></p>
<h4>Links</h4>
<ul>
<li><a href="https://github.com/niwibe/djorm-ext-core">https://github.com/niwibe/djorm-ext-core</a></li>
</ul>
    </div>
  </article>
        </div>
      </div>

    </div>
  </body>
</html>