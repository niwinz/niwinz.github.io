<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>niwi.nz : Table partitioning with PostgreSQL</title>
    <meta name=viewport content='width=200, initial-scale=1'>

  <meta name="desciption" content="PostgreSQL supports partitioning via table inheritance. So the partitioning is made in such a way that every child table inherits single parent table. Parent table is empty and it exists just to describe the whole data set. The real benefit of table partitioning is a performance improvement with tables with amount of huge data. Decreases a index size, because you create a distinct index for each partition and making it more likely that the heavily-used parts of the indexes fit in memory...." />
    <meta name="author" content="Andrey Antukh" />

    <link rel="stylesheet" href="https://niwi.nz/theme/css/main.css" />

      <link href="https://niwi.nz/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="niwi.nz Atom Feed" />


  </head>

  <body>
    <main>
      <div class="entry">
  <header>
    <a href="https://niwi.nz"><small>(return to home)</small></a>
    <h1>
      <a href="https://niwi.nz/2013/03/06/table-partitioning-with-postgresql/" id="page-title">Table partitioning with PostgreSQL</a>
    </h1>
    <div class="article-meta">
        <small class="time">
          Date:
          <time datetime="2013-03-06T00:00:00+00:00">
            Wed 06 March 2013
          </time>
        </small>
      <br />
      <small class="tags">
        Tags:
          <a href="https://niwi.nz/tag/postgresql.html">postgresql          </a>
      </small>

      <br />
      <small class="tags">
        Author:
          <span>Andrey Antukh</span>      </small>
    </div>
  </header>
  <article>
    <div id="article-content">
      <p>PostgreSQL supports partitioning via table inheritance. So the partitioning is made in such a way that every child table inherits single parent table. Parent table is empty and it exists just to describe the whole data set.</p>
<p>The real benefit of table partitioning is a performance improvement with tables with amount of huge data. Decreases a index size, because you create a distinct index for each partition and making it more likely that the heavily-used parts of the indexes fit in memory.</p>
<p>PostgreSQL table partitioning can be implemented in two ways: <strong>range partitioning</strong> or <strong>list partitioning</strong>.</p>
<p>Range partitioning can be done by ranges like (1-1000, 1001-2000, ...) and list partitioning can be done with explicit list of keys. There are no real differences between the two ways, you have to choose one depending on the problem to be solved.</p>
<div class="section" id="basic-steps-for-setup-table-partitioning">
<h2>Basic steps for setup table partitioning</h2>
<ul class="simple">
<li>Create a master table with all fields.</li>
<li>Create a some childs tables with inheritance and without any additional field.</li>
<li>Create indexes on each child.</li>
<li>Create a trigger function for correct insert data on child tables.</li>
<li>Enable constrain exclusion that improves performance on queries.</li>
</ul>
</div>
<div class="section" id="simple-example-of-data-partitioning">
<h2>Simple example of data partitioning</h2>
<p>Let's look at a basic example of how to set partitioning tables. To assume that we have a table
where we keep logs by country. Supose we have this table:</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">action_log</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="nb">TIMESTAMP</span><span class="w"> </span><span class="nb">WITH TIME ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="n">country_code</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mf">2</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="k">content</span><span class="w"> </span><span class="nb">text</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">action_log_country_code</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">action_log</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">country_code</span><span class="p">);</span><span class="w"></span>
</pre></div>
<p>On next step, create child tables and trigger:</p>
<div class="highlight"><pre><span></span><span class="c1">--- Child tables</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">action_log_fr</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">country_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;fr&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">INHERITS</span><span class="w"> </span><span class="p">(</span><span class="n">action_log</span><span class="p">);</span><span class="w"></span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">action_log_es</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">country_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;es&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">INHERITS</span><span class="w"> </span><span class="p">(</span><span class="n">action_log</span><span class="p">);</span><span class="w"></span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">action_log_fr_country_code</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">action_log_fr</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">country_code</span><span class="p">);</span><span class="w"></span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">action_log_es_country_code</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">action_log_es</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">btree</span><span class="w"> </span><span class="p">(</span><span class="n">country_code</span><span class="p">);</span><span class="w"></span>

<span class="c1">--- Trigger function</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">on_actionlog_insert</span><span class="p">()</span><span class="w"> </span><span class="k">RETURNS</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">$$</span><span class="w"></span>
<span class="k">BEGIN</span><span class="w"></span>
<span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">NEW</span><span class="mf">.</span><span class="n">country_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;es&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">action_log_es</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="k">NEW</span><span class="mf">.</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">ELSIF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">NEW</span><span class="mf">.</span><span class="n">country_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;fr&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">action_log_fr</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="k">NEW</span><span class="mf">.</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">ELSE</span><span class="w"></span>
<span class="w">        </span><span class="k">RAISE</span><span class="w"> </span><span class="k">EXCEPTION</span><span class="w"> </span><span class="s1">&#39;Country unknown&#39;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w"></span>
<span class="k">END</span><span class="p">;</span><span class="w"></span>
<span class="s">$$</span><span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="p">;</span><span class="w"></span>

<span class="c1">--- Attach trigger function to table</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">action_log_insert</span><span class="w"></span>
<span class="w">    </span><span class="k">BEFORE</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">action_log</span><span class="w"></span>
<span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="n">on_actionlog_insert</span><span class="p">();</span><span class="w"></span>
</pre></div>
<p>At this point, you can insert some data into action_log table. You will see what your data is
automaticaly redirected to correponding child tabl. Is totally transparent for user.</p>
<div class="highlight"><pre><span></span><span class="gp">test=#</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">action_log</span><span class="w"> </span><span class="p">(</span><span class="n">country_code</span><span class="p">,</span><span class="w"> </span><span class="k">content</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;en&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;content-en&#39;</span><span class="p">);</span><span class="w"></span>
<span class="gs">ERROR:</span><span class="gr">  Country unknown</span>
<span class="gp">test=#</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">action_log</span><span class="w"> </span><span class="p">(</span><span class="n">country_code</span><span class="p">,</span><span class="w"> </span><span class="k">content</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;es&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;content-es&#39;</span><span class="p">);</span><span class="w"></span>
<span class="go">INSERT 0 0</span>
<span class="gp">test=#</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">action_log</span><span class="w"> </span><span class="p">(</span><span class="n">country_code</span><span class="p">,</span><span class="w"> </span><span class="k">content</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;fr&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;content-fr&#39;</span><span class="p">);</span><span class="w"></span>
<span class="go">INSERT 0 0</span>
</pre></div>
<p>Now, if you make select on a master table (action_log), obtains all rows from
childs:</p>
<div class="highlight"><pre><span></span><span class="gp">test=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">action_log_es</span><span class="p">;</span><span class="w"></span>
<span class="go">          created_at           | country_code |  content</span>
<span class="go">-------------------------------+--------------+------------</span>
<span class="go"> 2013-03-07 22:54:45.859553+01 | es           | content-es</span>
<span class="go">(1 row)</span>

<span class="gp">test=#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">action_log</span><span class="p">;</span><span class="w"></span>
<span class="go">          created_at           | country_code |  content</span>
<span class="go">-------------------------------+--------------+------------</span>
<span class="go"> 2013-03-07 22:55:32.471027+01 | fr           | content-fr</span>
<span class="go"> 2013-03-07 22:54:45.859553+01 | es           | content-es</span>
<span class="go">(2 rows)</span>
</pre></div>
<p>If you analyze a query plan of any select, you will see that postgresql scans all
child tables:</p>
<div class="highlight"><pre><span></span><span class="gp">test=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">ANALYZE</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">action_log</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">country_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;es&#39;</span><span class="p">;</span><span class="w"></span>
<span class="go">                                            QUERY PLAN</span>
<span class="go">----------------------------------------------------------------------------------------------------------</span>
<span class="go"> Result  (cost=0.00..25.52 rows=11 width=52) (actual time=0.041..0.047 rows=1 loops=1)</span>
<span class="go">   -&gt;  Append  (cost=0.00..25.52 rows=11 width=52) (actual time=0.037..0.040 rows=1 loops=1)</span>
<span class="go">         -&gt;  Seq Scan on action_log  (cost=0.00..0.00 rows=1 width=52) (actual time=0.002..0.002 rows=0...</span>
<span class="go">               Filter: (country_code = &#39;es&#39;::bpchar)</span>
<span class="go">         -&gt;  Bitmap Heap Scan on action_log_fr action_log  (cost=4.29..12.76 rows=5 width=52) (actual t...</span>
<span class="go">               Recheck Cond: (country_code = &#39;es&#39;::bpchar)</span>
<span class="go">               -&gt;  Bitmap Index Scan on action_log_fr_country_code  (cost=0.00..4.29 rows=5 width=0) (a...</span>
<span class="go">                     Index Cond: (country_code = &#39;es&#39;::bpchar)</span>
<span class="go">         -&gt;  Bitmap Heap Scan on action_log_es action_log  (cost=4.29..12.76 rows=5 width=52) (actual t...</span>
<span class="go">               Recheck Cond: (country_code = &#39;es&#39;::bpchar)</span>
<span class="go">               -&gt;  Bitmap Index Scan on action_log_es_country_code  (cost=0.00..4.29 rows=5 width=0) (a...</span>
<span class="go">                     Index Cond: (country_code = &#39;es&#39;::bpchar)</span>
<span class="go"> Total runtime: 0.108 ms</span>
<span class="go">(13 rows)</span>
</pre></div>
<p>This behavior is not optimal but postgresql have one option that help exclude child tables by contrain
defined with CHECK statement. You can activate it with:</p>
<div class="highlight"><pre><span></span><span class="gp">test=#</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">constraint_exclusion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span><span class="w"></span>
<span class="go">SET</span>
</pre></div>
<p>Now, this is a query-plan of previos query but with <strong>constraint_exclusion</strong> activated:</p>
<div class="highlight"><pre><span></span><span class="gp">test=#</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">ANALYZE</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">action_log</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">country_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;es&#39;</span><span class="p">;</span><span class="w"></span>
<span class="go">                                            QUERY PLAN</span>
<span class="go">----------------------------------------------------------------------------------------------------------</span>
<span class="go"> Result  (cost=0.00..12.76 rows=6 width=52) (actual time=0.030..0.035 rows=1 loops=1)</span>
<span class="go">   -&gt;  Append  (cost=0.00..12.76 rows=6 width=52) (actual time=0.026..0.029 rows=1 loops=1)</span>
<span class="go">         -&gt;  Seq Scan on action_log  (cost=0.00..0.00 rows=1 width=52) (actual time=0.002..0.002 rows=0...</span>
<span class="go">               Filter: (country_code = &#39;es&#39;::bpchar)</span>
<span class="go">         -&gt;  Bitmap Heap Scan on action_log_es action_log  (cost=4.29..12.76 rows=5 width=52) (actual t...</span>
<span class="go">               Recheck Cond: (country_code = &#39;es&#39;::bpchar)</span>
<span class="go">               -&gt;  Bitmap Index Scan on action_log_es_country_code  (cost=0.00..4.29 rows=5 width=0) (a...</span>
<span class="go">                     Index Cond: (country_code = &#39;es&#39;::bpchar)</span>
<span class="go"> Total runtime: 0.081 ms</span>
<span class="go">(9 rows)</span>
</pre></div>
<p>In conclusion, setup table partitioning with postgresql is very simple and improved considerably performance with tables with huge amount of data.</p>
<p>Can see more information on official documentation: <a class="reference external" href="http://www.postgresql.org/docs/9.2/static/ddl-partitioning.html">http://www.postgresql.org/docs/9.2/static/ddl-partitioning.html</a></p>
</div>
<div class="section" id="related-links">
<h2>Related links</h2>
<ul class="simple">
<li><a class="reference external" href="http://www.if-not-true-then-false.com/2009/howto-create-postgresql-table-partitioning-part-1/">http://www.if-not-true-then-false.com/2009/howto-create-postgresql-table-partitioning-part-1/</a></li>
<li><a class="reference external" href="http://www.if-not-true-then-false.com/2009/performance-testing-between-partitioned-and-non-partitioned-postgresql-tables-part-3/">http://www.if-not-true-then-false.com/2009/performance-testing-between-partitioned-and-non-partitioned-postgresql-tables-part-3/</a></li>
<li><a class="reference external" href="http://www.mkyong.com/database/partition-table-in-postgresql-create-partition-part-1/">http://www.mkyong.com/database/partition-table-in-postgresql-create-partition-part-1/</a></li>
<li><a class="reference external" href="http://www.mkyong.com/database/partition-table-in-postgresql-simulate-millions-data-part-2/">http://www.mkyong.com/database/partition-table-in-postgresql-simulate-millions-data-part-2/</a></li>
<li><a class="reference external" href="http://www.mkyong.com/database/performance-testing-on-partition-table-in-postgresql-part-3/">http://www.mkyong.com/database/performance-testing-on-partition-table-in-postgresql-part-3/</a></li>
<li><a class="reference external" href="http://www.linuxforu.com/2012/01/partitioning-in-postgresql/">http://www.linuxforu.com/2012/01/partitioning-in-postgresql/</a></li>
</ul>
</div>

    </div>
  </article>
      </div>
      </div>
    </main>
  </body>
</html>