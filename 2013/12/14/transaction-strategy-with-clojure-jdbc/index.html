<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>niwi.nz : Transaction strategy with Clojure JDBC</title>
    <meta name=viewport content='width=200, initial-scale=1'>

  <meta name="desciption" content="In previous article, I have introduced a new jdbc library for clojure. On this article I want introduce one of the new features that it have. clojure.jdbc comes with powerful tranasaction management, in comparison with clojure.java.jdbc it, by default, handles well subtransactions. All transaction block works as an atomic unit. But in some cases, a uses wants relaxe this transaction management such as all nested transactions are grouped into the first/main transaction. Thanks to the new..." />
    <meta name="author" content="Andrey Antukh" />

    <link rel="stylesheet" href="https://niwi.nz/theme/css/main.css" />

      <link href="https://niwi.nz/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="niwi.nz Atom Feed" />

      <link href="https://niwi.nz/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="niwi.nz RSS Feed" />

    <!--[if IE]>
        <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!--[if lte IE 7]>
        <link rel="stylesheet" type="text/css" media="all" href="https://niwi.nz/css/ie.css"/>
        <script src="https://niwi.nz/js/IE8.js" type="text/javascript"></script>
    <![endif]-->

    <!--[if lt IE 7]>
        <link rel="stylesheet" type="text/css" media="all" href="https://niwi.nz/css/ie6.css"/>
    <![endif]-->
  </head>

  <body>
    <div id="wrap">
      <div id="container">

        <div class="entry">
  <header>
    <a href="https://niwi.nz"><small>(return to home)</small></a>
    <h1>
      <a href="https://niwi.nz/2013/12/14/transaction-strategy-with-clojure-jdbc/" id="page-title">Transaction strategy with Clojure JDBC</a>
    </h1>
    <div class="article-meta">
        <small class="time">
          Date:
          <time datetime="2013-12-14T00:00:00+00:00">
            Sat 14 December 2013
          </time>
        </small>
      <br />
      <small class="tags">
        Tags:
          <a href="https://niwi.nz/tag/clojure.html">clojure,           </a>
          <a href="https://niwi.nz/tag/jdbc.html">jdbc          </a>
      </small>

      <br />
      <small class="tags">
        Author:
          <span>Andrey Antukh</span>      </small>
    </div>
  </header>
  <article>
    <div id="article-content">
      <p>In previous article, I have introduced a new jdbc library for clojure. On this article I want
introduce one of the new features that it have.</p>
<p>clojure.jdbc comes with powerful tranasaction management, in comparison with clojure.java.jdbc it,
by default, handles well subtransactions. All transaction block works as an atomic unit. But in
some cases, a uses wants relaxe this transaction management such as all nested transactions
are grouped into the first/main transaction.</p>
<p>Thanks to the new feauture, introduced in the last version of clojure.jdbc (0.1.0-beta4) you can
change a transaction strategy without change any other code of your application.</p>
<p>For show one example, we go to imitate a simple transaction management available in
clojure.java.jdbc. For it, we go to make a new implementation of <tt class="docutils literal">ITransactionStrategy</tt>
protocol available in <tt class="docutils literal">jdbc</tt> namespace:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">defrecord </span><span class="nv">BasicTransactionStrategy</span> <span class="p">[]</span>
  <span class="nv">ITransactionStrategy</span>
  <span class="p">(</span><span class="nf">begin</span> <span class="p">[</span><span class="nv">_</span> <span class="nv">conn</span> <span class="nv">opts</span><span class="p">]</span>
    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">depth</span>    <span class="p">(</span><span class="ss">:depth-level</span> <span class="nv">conn</span><span class="p">)</span>
          <span class="nv">raw-conn</span> <span class="p">(</span><span class="ss">:connection</span> <span class="nv">conn</span><span class="p">)]</span>
      <span class="p">(</span><span class="k">if </span><span class="nv">depth</span>
        <span class="p">(</span><span class="nb">assoc </span><span class="nv">conn</span> <span class="ss">:depth-level</span> <span class="p">(</span><span class="nb">inc </span><span class="p">(</span><span class="ss">:depth-level</span> <span class="nv">conn</span><span class="p">)))</span>
        <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">prev-autocommit-state</span> <span class="p">(</span><span class="nf">.getAutoCommit</span> <span class="nv">raw-conn</span><span class="p">)]</span>
          <span class="p">(</span><span class="nf">.setAutoCommit</span> <span class="nv">raw-conn</span> <span class="nv">false</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">assoc </span><span class="nv">conn</span> <span class="ss">:depth-level</span> <span class="mi">0</span> <span class="ss">:prev-autocommit-state</span> <span class="nv">prev-autocommit-state</span><span class="p">)))))</span>

  <span class="p">(</span><span class="nf">rollback</span> <span class="p">[</span><span class="nv">_</span> <span class="nv">conn</span> <span class="nv">opts</span><span class="p">]</span>
    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">depth</span>    <span class="p">(</span><span class="ss">:depth-level</span> <span class="nv">conn</span><span class="p">)</span>
          <span class="nv">raw-conn</span> <span class="p">(</span><span class="ss">:connection</span> <span class="nv">conn</span><span class="p">)]</span>
      <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">depth</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">do</span>
          <span class="p">(</span><span class="nf">.rollback</span> <span class="nv">raw-conn</span><span class="p">)</span>
          <span class="p">(</span><span class="nf">.setAutoCommit</span> <span class="nv">raw-conn</span> <span class="p">(</span><span class="ss">:prev-autocommit-state</span> <span class="nv">conn</span><span class="p">))</span>
          <span class="p">(</span><span class="nb">dissoc </span><span class="nv">conn</span> <span class="ss">:depth-level</span> <span class="ss">:prev-autocommit-state</span><span class="p">))</span>
        <span class="nv">conn</span><span class="p">)))</span>

  <span class="p">(</span><span class="nf">commit</span> <span class="p">[</span><span class="nv">_</span> <span class="nv">conn</span> <span class="nv">opts</span><span class="p">]</span>
    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">depth</span>    <span class="p">(</span><span class="ss">:depth-level</span> <span class="nv">conn</span><span class="p">)</span>
          <span class="nv">raw-conn</span> <span class="p">(</span><span class="ss">:connection</span> <span class="nv">conn</span><span class="p">)]</span>
      <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">depth</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">do</span>
          <span class="p">(</span><span class="nf">.commit</span> <span class="nv">raw-conn</span><span class="p">)</span>
          <span class="p">(</span><span class="nf">.setAutoCommit</span> <span class="nv">raw-conn</span> <span class="p">(</span><span class="ss">:prev-autocommit-state</span> <span class="nv">conn</span><span class="p">))</span>
          <span class="p">(</span><span class="nb">dissoc </span><span class="ss">:depth-level</span> <span class="ss">:prev-autocommit-state</span><span class="p">))</span>
        <span class="nv">conn</span><span class="p">))))</span>
</pre></div>
<p>As you can see, is not very complicated. It simply consist on three methods. If you want disable completely
transaction management you can implement some dummy transaction strategy like this:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="kd">defrecord </span><span class="nv">DummyTransactionStrategy</span> <span class="p">[]</span>
  <span class="nv">ITransactionStrategy</span>
  <span class="p">(</span><span class="nf">begin</span> <span class="p">[</span><span class="nv">_</span> <span class="nv">conn</span> <span class="nv">opts</span><span class="p">]</span> <span class="nv">conn</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">rollback</span> <span class="p">[</span><span class="nv">_</span> <span class="nv">conn</span> <span class="nv">opts</span><span class="p">]</span> <span class="nv">conn</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">commit</span> <span class="p">[</span><span class="nv">_</span> <span class="nv">conn</span> <span class="nv">opts</span><span class="p">]</span> <span class="nv">conn</span><span class="p">))</span>
</pre></div>
<p>And this is a simple example of how you can use one of previously defined strategies on your code:</p>
<div class="highlight"><pre><span></span><span class="c1">;; Simple macro usage</span>

<span class="p">(</span><span class="nf">with-connection</span> <span class="p">[</span><span class="nv">conn</span> <span class="nv">dbspec</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">with-transaction-strategy</span> <span class="nv">conn</span> <span class="p">(</span><span class="nf">DummyTransactionStrategy.</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">do-some-thing</span> <span class="nv">conn</span><span class="p">)))</span>

<span class="c1">;; Or more low level access</span>

<span class="p">(</span><span class="nb">with-open </span><span class="p">[</span><span class="nv">conn</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">make-connection</span> <span class="nv">dbspec</span><span class="p">)</span>
                     <span class="p">(</span><span class="nf">wrap-transaction-strategy</span> <span class="p">(</span><span class="nf">BasicTransactionStrategy.</span><span class="p">)))]</span>
  <span class="p">(</span><span class="nf">do-some-thing</span> <span class="nv">conn</span><span class="p">))</span>
</pre></div>
<p>You can read more about it on the <a class="reference external" href="http://niwibe.github.io/clojure.jdbc/">project documentation</a>
or view a source code on <a class="reference external" href="https://github.com/niwibe/clojure.jdbc">Github</a>.</p>

    </div>
  </article>
        </div>
      </div>

    </div>
  </body>
</html>