<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>niwi.nz : Index usage statistics in PostgreSQL</title>
    <meta name="viewport" content="width=200, initial-scale=1" />
  <meta name="desciption" content="This is a simple tip for obtain statistic information about indexes usage on a current database. All information is obtained from some views exposed by PostgreSQL, and populated by the Statistics Collector. Tips of this post only exposes some facility for obtain these information (filtered by current database and exclude system indexes). Helper sql functions Sql function that returns a table with I/O infomation (obtained from pg_statio_user_indexes view) and filtered by current database and..." />
    <meta name="author" content="Andrey Antukh" />

    <link rel="stylesheet" href="https://niwi.nz/theme/css/main.css" />

      <link href="https://niwi.nz/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="niwi.nz Atom Feed" />


  </head>

  <body>
    <main>
  <header>
    <a class="back" href="https://niwi.nz"><< back</a>
    <h1>
      <a href="https://niwi.nz/2013/02/19/index-usage-stats-in-postgresql/" id="page-title">Index usage statistics in PostgreSQL</a>
    </h1>
    <div class="article-meta">
        <small class="time">
          Date:
          <time datetime="2013-02-19T00:00:00+00:00">
            Tue 19 February 2013
          </time>
        </small>
      <br />
      <small class="tags">
        Tags:
          <a href="https://niwi.nz/tag/postgresql.html">postgresql          </a>
      </small>

      <br />
      <small class="tags">
        Author:
          <span>Andrey Antukh</span>      </small>
    </div>
  </header>
  <article>
    <p>This is a simple tip for obtain statistic information about indexes usage on a
current database. All information is obtained from some views exposed by PostgreSQL,
and populated by the Statistics Collector.</p>
<p>Tips of this post only exposes some facility for obtain these information (filtered
by current database and exclude system indexes).</p>
<div class="section" id="helper-sql-functions">
<h2>Helper sql functions</h2>
<p>Sql function that returns a table with I/O infomation (obtained from pg_statio_user_indexes view)
and filtered by current database and &quot;public&quot; schema:</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">indexes_io_for_current_database</span><span class="p">()</span><span class="w"></span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">TABLE</span><span class="p">(</span><span class="n">indexname</span><span class="w"> </span><span class="k">name</span><span class="p">,</span><span class="w"> </span><span class="n">idx_blks_read</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> </span><span class="n">idx_blks_hit</span><span class="w"> </span><span class="nb">bigint</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">$$</span><span class="w"></span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">i</span><span class="mf">.</span><span class="n">indexrelname</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="mf">.</span><span class="n">idx_blks_read</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="mf">.</span><span class="n">idx_blks_hit</span><span class="w"></span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_statio_user_indexes</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">i</span><span class="mf">.</span><span class="n">relname</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">table_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="mf">.</span><span class="k">tables</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">table_schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;public&#39;</span><span class="p">);</span><span class="w"></span>
<span class="s">$$</span><span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="k">SQL</span><span class="p">;</span><span class="w"></span>
</pre></div>
<p>Sql function that returns a table with index usage infomation (obtained from pg_stat_user_indexes view)
and filtered by current database and &quot;public&quot; schema:</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">indexes_stat_for_current_database</span><span class="p">()</span><span class="w"></span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">TABLE</span><span class="p">(</span><span class="n">indexname</span><span class="w"> </span><span class="k">name</span><span class="p">,</span><span class="w"> </span><span class="n">idx_scan</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> </span><span class="n">idx_tup_read</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> </span><span class="n">idx_tup_fetch</span><span class="w"> </span><span class="nb">bigint</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">$$</span><span class="w"></span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">i</span><span class="mf">.</span><span class="n">indexrelname</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="mf">.</span><span class="n">idx_scan</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="mf">.</span><span class="n">idx_tup_read</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="mf">.</span><span class="n">idx_tup_fetch</span><span class="w"></span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_user_indexes</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">i</span><span class="mf">.</span><span class="n">relname</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">table_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="mf">.</span><span class="k">tables</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">table_schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;public&#39;</span><span class="p">);</span><span class="w"></span>
<span class="s">$$</span><span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="k">SQL</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="examples">
<h2>Examples</h2>
<p>The simple way to obtain a last 5 most used indexes on your database:</p>
<div class="highlight"><pre><span></span><span class="gp">foodb=&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">indexes_stat_for_current_database</span><span class="p">()</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">idx_scan</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span><span class="w"></span>
<span class="go">           indexname           | idx_scan | idx_tup_read | idx_tup_fetch</span>
<span class="go">-------------------------------+----------+--------------+---------------</span>
<span class="go"> auth_user_pkey                | 20074525 |    141906772 |     141898258</span>
<span class="go"> profile_user_id_key           |  8147399 |      7923886 |       7918973</span>
<span class="go"> actionlog_created_date        |  6452507 |      6452508 |       6452505</span>
<span class="go"> actionlog_to_user_id          |  4438980 |    282814752 |            20</span>
<span class="go"> actionlog_from_user_id        |  4018583 |     45458783 |      11955250</span>
<span class="go">(5 rows)</span>
</pre></div>
<p>Also, simple way for obtain the 5 indexes with most hits from buffers (cache?)</p>
<div class="highlight"><pre><span></span><span class="gp">foodb=&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">indexes_io_for_current_database</span><span class="p">()</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">idx_blks_hit</span><span class="w"> </span><span class="k">desc</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span><span class="w"></span>
<span class="go">           indexname           | idx_blks_read | idx_blks_hit</span>
<span class="go">-------------------------------+---------------+--------------</span>
<span class="go"> auth_user_pkey                |           441 |     41678422</span>
<span class="go"> profile_user_id_key           |          1071 |     17219297</span>
<span class="go"> actionlog_created_date        |           713 |     12950554</span>
<span class="go"> actionlog_to_user_id          |          6993 |      9899807</span>
<span class="go"> actionlog_from_user_id        |          2117 |      8234565</span>
<span class="go">(5 rows)</span>
</pre></div>
</div>
<div class="section" id="links">
<h2>Links</h2>
<p>For more information you can see these links to the official postgresql documentation:</p>
<ul class="simple">
<li><a class="reference external" href="http://www.postgresql.org/docs/9.2/static/monitoring-stats.html">http://www.postgresql.org/docs/9.2/static/monitoring-stats.html</a></li>
</ul>
</div>

  </article>
      </div>
    </main>
  </body>
</html>