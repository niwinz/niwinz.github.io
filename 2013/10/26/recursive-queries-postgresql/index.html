<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>niwi.nz : Recursive queries with PostgreSQL</title>
    <meta name=viewport content='width=200, initial-scale=1'>

  <meta name="desciption" content="Sometimes we need store some graph/tree structures in your relational database (eg, postgresql) and query childs of some top level node of your stored tree. This problem, has various soultions. The most simple way to get all child nodes of one top level node is execute query for each tree depth. But for large trees with 5+ levels of nesting, this is pretty slow. PostgreSQL offers recursive queries that helps a lot obtaining all child nodes. Sample data Here, we will try both methods for..." />
    <meta name="author" content="Andrey Antukh" />

    <link rel="stylesheet" href="https://niwi.nz/theme/css/main.css" />

      <link href="https://niwi.nz/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="niwi.nz Atom Feed" />

      <link href="https://niwi.nz/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="niwi.nz RSS Feed" />

    <!--[if IE]>
        <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!--[if lte IE 7]>
        <link rel="stylesheet" type="text/css" media="all" href="https://niwi.nz/css/ie.css"/>
        <script src="https://niwi.nz/js/IE8.js" type="text/javascript"></script>
    <![endif]-->

    <!--[if lt IE 7]>
        <link rel="stylesheet" type="text/css" media="all" href="https://niwi.nz/css/ie6.css"/>
    <![endif]-->
  </head>

  <body>
    <div id="wrap">
      <div id="container">

        <div class="entry">
  <header>
    <a href="https://niwi.nz"><small>(return to home)</small></a>
    <h1>
      <a href="https://niwi.nz/2013/10/26/recursive-queries-postgresql/" id="page-title">Recursive queries with PostgreSQL</a>
    </h1>
    <div class="article-meta">
        <small class="time">
          Date:
          <time datetime="2013-10-26T00:00:00+00:00">
            Sat 26 October 2013
          </time>
        </small>
      <br />
      <small class="tags">
        Tags:
          <a href="https://niwi.nz/tag/postgresql.html">postgresql          </a>
      </small>

      <br />
      <small class="tags">
        Author:
          <span>Andrey Antukh</span>      </small>
    </div>
  </header>
  <article>
    <div id="article-content">
      <p>Sometimes we need store some graph/tree structures in your relational database (eg, postgresql)
and query childs of some top level node of your stored tree.</p>
<p>This problem, has various soultions.</p>
<p>The most simple way to get all child nodes of one top level node is execute query for each
tree depth. But for large trees with 5+ levels of nesting, this is pretty slow.</p>
<p>PostgreSQL offers recursive queries that helps a lot obtaining all child nodes.</p>
<div class="section" id="sample-data">
<h2>Sample data</h2>
<p>Here, we will try both methods for obtain a child nodes. For this experimet we will used these sql data:</p>
<div class="highlight"><pre><span></span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">node</span><span class="p">;</span><span class="w"></span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">parent_id</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>

<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="k">VALUES</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;node 1&#39;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;node 2&#39;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;node 3&#39;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w">    </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;node 4&#39;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w">    </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;node 5&#39;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w">    </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;node 6&#39;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w">    </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;node 7&#39;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w">    </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;node 8&#39;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;node 9&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="experiment-code">
<h2>Experiment code</h2>
<p>Watching this snippet, we can obseve two main functions, firts implements a simple way for obtain all chinlds
and second use postgresql recursive query for do same thing.</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">functools</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">text</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;postgresql+psycopg2://localhost/test&#39;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">bench</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator used for benchmark execution of arbitrary function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">bench</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1000.0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] Elapsed time: </span><span class="si">{}</span><span class="s2"> msecs.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">delta</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">_wrapper</span>

<span class="nd">@bench</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;simple&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dump_simple</span><span class="p">():</span>
    <span class="n">sm_s</span> <span class="o">=</span> <span class="n">text</span><span class="p">(</span><span class="s2">&quot;select id, parent_id, name from node where parent_id = :parent_id order by name;&quot;</span><span class="p">)</span>
    <span class="n">sm_n</span> <span class="o">=</span> <span class="n">text</span><span class="p">(</span><span class="s2">&quot;select id, parent_id, name from node where id = :id;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_parents</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sm_s</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="n">parent_id</span><span class="p">)</span>
        <span class="n">final_results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">final_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">final_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_parents</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">final_results</span>

    <span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sm_n</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">first</span><span class="p">]</span> <span class="o">+</span> <span class="n">get_parents</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dumps</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="nd">@bench</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;recursive&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dump_recursive</span><span class="p">():</span>
    <span class="n">sm_s</span> <span class="o">=</span> <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        WITH RECURSIVE nodes_cte AS (</span>
<span class="s2">            SELECT n.id, n.parent_id, n.name, n.id::TEXT AS path</span>
<span class="s2">                FROM node AS n</span>
<span class="s2">                WHERE n.parent_id = :id</span>
<span class="s2">            UNION ALL</span>
<span class="s2">            SELECT c.id, c.parent_id, c.name, (p.path || &#39;-&gt;&#39; || c.id::TEXT) AS path</span>
<span class="s2">                FROM nodes_cte AS p, node AS c</span>
<span class="s2">                WHERE c.parent_id = p.id</span>
<span class="s2">        )</span>
<span class="s2">        (</span>
<span class="s2">            SELECT id, parent_id, name, &#39;&#39; as path FROM node WHERE id = :id</span>
<span class="s2">            UNION ALL</span>
<span class="s2">            SELECT * FROM nodes_cte ORDER BY path ASC</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sm_s</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">dump_simple</span><span class="p">())</span>
    <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">dump_recursive</span><span class="p">())</span>
</pre></div>
</div>
<div class="section" id="benchmarking">
<h2>Benchmarking</h2>
<p>This is a result of executing a code snippet:</p>
<div class="highlight"><pre><span></span>[simple] Elapsed time: 25.171 msecs.
[(1, None, &#39;node 1&#39;),
 (3, 1, &#39;node 3&#39;),
 (4, 3, &#39;node 4&#39;),
 (6, 4, &#39;node 6&#39;),
 (7, 6, &#39;node 7&#39;),
 (8, 7, &#39;node 8&#39;),
 (9, 1, &#39;node 9&#39;)]
[recursive] Elapsed time: 2.727 msecs.
[(1, None, &#39;node 1&#39;, &#39;&#39;),
 (3, 1, &#39;node 3&#39;, &#39;3&#39;),
 (4, 3, &#39;node 4&#39;, &#39;3-&gt;4&#39;),
 (6, 4, &#39;node 6&#39;, &#39;3-&gt;4-&gt;6&#39;),
 (7, 6, &#39;node 7&#39;, &#39;3-&gt;4-&gt;6-&gt;7&#39;),
 (8, 7, &#39;node 8&#39;, &#39;3-&gt;4-&gt;6-&gt;7-&gt;8&#39;),
 (9, 1, &#39;node 9&#39;, &#39;9&#39;)]
</pre></div>
<p>Watching a postgresql log of execute <cite>dump_simple</cite> function:</p>
<div class="highlight"><pre><span></span>LOG:  duration: 0.039 ms  statement: BEGIN
LOG:  duration: 0.558 ms  statement: select id, parent_id, name from node where id = 1;
LOG:  duration: 0.861 ms  statement: select id, parent_id, name from node where parent_id = 1 order by name;
LOG:  duration: 0.238 ms  statement: select id, parent_id, name from node where parent_id = 3 order by name;
LOG:  duration: 0.234 ms  statement: select id, parent_id, name from node where parent_id = 4 order by name;
LOG:  duration: 0.235 ms  statement: select id, parent_id, name from node where parent_id = 6 order by name;
LOG:  duration: 0.234 ms  statement: select id, parent_id, name from node where parent_id = 7 order by name;
LOG:  duration: 0.229 ms  statement: select id, parent_id, name from node where parent_id = 8 order by name;
LOG:  duration: 0.227 ms  statement: select id, parent_id, name from node where parent_id = 9 order by name;
LOG:  duration: 0.027 ms  statement: COMMIT
</pre></div>
<p>And this is a postgresql log of executing a <cite>dump_recursive</cite> function:</p>
<div class="highlight"><pre><span></span>LOG:  duration: 0.019 ms  statement: BEGIN
LOG:  duration: 1.334 ms  statement:
                WITH RECURSIVE nodes_cte AS (
                    SELECT n.id, n.parent_id, n.name, n.id::TEXT AS path
                        FROM node AS n
                        WHERE n.parent_id = 1
                    UNION ALL
                    SELECT c.id, c.parent_id, c.name, (p.path || &#39;-&gt;&#39; || c.id::TEXT) AS path
                        FROM nodes_cte AS p, node AS c
                        WHERE c.parent_id = p.id
                )
                (
                    SELECT id, parent_id, name, &#39;&#39; as path FROM node WHERE id = 1
                    UNION ALL
                    SELECT * FROM nodes_cte ORDER BY path ASC
                );
LOG:  duration: 0.031 ms  statement: COMMIT
</pre></div>
<p>We can observe, that using recursive query we can obtain a same results in more less time that using
a simple way (execute query for each depth) of obtain child nodes.</p>
</div>

    </div>
  </article>
        </div>
      </div>

    </div>
  </body>
</html>